---
# Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
title: "Querying Vespa"
---

<p>
Query requests are sent using the <a href="query-api.html">Query API</a> -
components and data flow:
</p><p>
<img src="img/query-to-response.svg" height="390" width="458"/>
</p><p>
A query has two phases:
<ol>
  <li><strong>Query phase:</strong> Matching, ranking and grouping/aggregation.
      This phase dispatches the query to content nodes</li>
  <li><strong>Result processing phase:</strong> Content fetching
      and snippeting of the top global hits found in the query phase</li>
</ol>
The above is an simplification - if the query also specifies <a href="grouping.html">result grouping</a>,
the query phase might involve multiple phases or roundtrips between the container and content nodes.
</p>



<h2 id="query-phase">Query phase</h2>
<ol>
  <li>
    A query is sent from a front-end application to a container node
    using the <a href="query-api.html">query API</a> or in any custom request format handled by a
    custom <a href="jdisc/developing-request-handlers.html">request handler</a>,
    which translates the custom request format to native Vespa APIs.
  </li><li>
    Query pre-processing, like <a href="linguistics.html">linguistic processing</a>
    and <a href="query-rewriting.html">query rewriting</a>,
    is done in <a href="chained-components.html">chains</a>
  </li><li>
    <p>
    The query is sent from the container to
    <a href="schemas.html#querying-multiple-document-types">selected</a> content clusters -
    see <a href="federation.html">federation</a> for more details.
    The illustration above has one content cluster but multiple is fully supported
    and allows scaling <a href="schemas.html">document types</a> differently.
    E.g. a <em>tweet</em> document type can be indexed in a separate content cluster
    from a <em>user</em> document type, enabling independent scaling of the two.
    </p><p>
    <img src="img/reference/flow/query1.svg" height="193" width="368"/>
    </p>
  </li><li>
    At this point the query enters one or more <a href="reference/services-content.html">content clusters</a>.
    In a content cluster with <a href="elastic-vespa.html#grouped-distribution">grouped distribution</a>,
    the query is dispatched to one group at a time using a
    <a href="reference/services-content.html#dispatch-tuning">dispatch policy</a>,
    while with a flat single group content cluster the query is dispatched to all content nodes.
  </li><li>
    <p>
    The query arrives at the content nodes which performs matching,
    <a href="ranking.html">ranking</a> and aggregation/grouping over the set of documents
    in the <a href="proton.html">Ready sub database</a>.
    <em>vespa-proton</em> does matching over the <em>ready</em> documents
    and <a href="ranking.html">ranks</a> as specified with the request/schema.
    Each content node matches and ranks a subset of the total document corpus
    and returns the hits along with meta information
    like total hits and sorting and grouping data, if requested.
    </p><p>
    <img src="content/img/elastic-query.svg" height="320" width="270"/>
    </p>
  </li><li>
    Once the content nodes within the group have replied within the <a href="graceful-degradation.html">timeout</a>,
    <a href="reference/services-content.html#dispatch-tuning">max-hits / top-k</a>
    results are returned to the container for query phase result processing.
    In this phase, the only per hit data available is the internal global document id (gid) and the ranking score.
    There is also result meta information like coverage and total hit count.
    Additional hit specific data, like the contents of fields,
    is not available until the result processing phase has completed the content fetching.
   </li>
</ol>



<h2 id="result-processing-fill-phase">Result processing (fill) phase</h2>
<ul>
  <li>
    When the result from the query phase is available,
    a custom chained <a href="searcher-development.html#multiphase-searching">searcher component</a>
    can process the limited data available from the first search phase
    before contents of the hits is fetched from the content nodes.
    The fetching from content nodes is lazy and is not invoked before rendering the response,
    unless asked for earlier by a custom searcher component.
  </li><li>
    Only fields in the requested <a href="document-summaries.html">document summaries</a> is fetched from content nodes.
    The summary request goes directly to the content nodes that produced the result from the query phase.
  </li><li>
    After the content node requests have completed,
    the full result set can be processed further by custom components
    (e.g. doing result deduping, top-k re-ranking),
    before <a href="result-rendering.html">rendering</a> the response.
  </li>
</ul>
