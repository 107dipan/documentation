---
# Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
title: "Vespa information flow"
---

<p>
This document details how information moves through a Vespa system.
</p>



<h2 id="query">...when querying from an application</h2>
<p>
By "querying from an application" we mean an action by a user to search through the set of documents
that has already been fed to and indexed.
The query exists as a human readable string similar to what any user of a search engine could write.
</p><p>
Information moves through the system according to figure 3:
</p>
<ol>
  <li>
    A query arrives from a front-end application to one of several Query Result Server nodes (QRS).
    The node that is used is given by the front-end, and is of no concern to Vespa -
    if a QRS is down, it is up to the front-end to relay the query to one of the other nodes.
  </li><li>
    Any required processing of the query is done by the <code>qrs</code>-binary itself.
    This includes narrowing down of the search, such as stemming and geo-tagging.
  </li><li>
    Unless otherwise specified by the query, it is distributed by the QRS to all search clusters in the system.
    Because the selection of top level dispatcher (TLD) is done by a hash of the query,
    it is viable to cache query-results even on TLD's.
  </li>
</ol>
<p align="center">
<img src="../img/reference/flow/query1.png" /><br />
<strong>Figure 3:</strong> Information flow in Vespa when querying from an application
</p><p>
At this point the query enters one or more search clusters, and information flows according to figure 4:
</p>
<ol>
  <li>
    Like all services in Vespa, the dispatcher service (with binary <code>vespa-dispatch</code>)
    is run by the <code>vespa-config-sentinel</code>.
    This service subscribes to its configuration from the local <code>config-proxy</code>,
    and its primary task is to relay the query such that it covers the entire document base,
    with the lowest possible maximum load on its relevant search nodes.
    The TLD knows what queries are being processed and at which nodes,
    and load balancing is done by dispatching to the node with the lowest number of running queries.
    <ol type="a">
      <li>
        The query arrives at each searchnode's local dispatcher
        (binary is the same as for TLD, <code>vespa-dispatch</code>).
        This dispatcher allocates search threads in binary
        <code>vespa-proton</code> to perform a search in the local index for the query.
        The two modes of the <code>vespa-dispatch</code> binary are separable in the log files by their entry;
        the search node writes:
<pre>
(...) searchnode.dispatch0.dispatch
vespa-dispatch (...)
</pre>
        whereas the top level dispatcher writes:
<pre>
(...)
topleveldispatch vespa-dispatch (...)
</pre>

      </li><li>
        <code>vespa-proton</code> searches its memory index or the local disk index files in
        <code>$VESPA_HOME/var/db/vespa/search/</code> and returns its results back to the local dispatcher.
      </li>
    </ol>
  </li><li>
    When all search nodes have responded to the TLD, it merges their partial results
    and relays this back to the QRS.
  </li><li>
    The QRS performs any required processing of the results, possibly requerying data if needed,
    before it finally returns these to the querying entity.
  </li>
</ol>
<p align="center">
<img src="../img/reference/flow/query2.png" /><br />
<strong>Figure 4:</strong> Information flow in Vespa when querying from an application, detail of search cluster
</p>
